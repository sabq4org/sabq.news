

### **البريف التنفيذي: نظام إدارة السمات المتقدم**

**للإدارة العليا وأصحاب المصلحة**

**الموضوع:** تمكين العلامة التجارية الديناميكية لمنصة "سبق الذكية" من خلال نظام إدارة سمات على مستوى مؤسسي.

**1. الملخص التنفيذي**

يقترح هذا المشروع بناء نظام متقدم لإدارة السمات (Theme Management) يسمح لمنصة "سبق الذكية" بالتحول من هوية بصرية ثابتة إلى هوية ديناميكية تتكيف مع المناسبات الوطنية والحملات الترويجية. الهدف هو تمكين الفرق التحريرية والتسويقية من جدولة وتفعيل تغييرات بصرية كاملة (شعار، ألوان، خطوط، رايات) بشكل آمن ومؤتمت، مع ضمان العودة التلقائية للهوية الافتراضية. هذا النظام لن يزيد من تفاعل المستخدمين خلال الفعاليات الخاصة فحسب، بل سيرفع من كفاءة التشغيل ويقلل من الأخطاء البشرية، مع الحفاظ على سلامة العلامة التجارية من خلال آليات صارمة للإشراف والتدقيق.

**2. المبادئ الأساسية للنظام**

*   **التحكم الديناميكي والجدولة:** القدرة على تخطيط وتفعيل الحملات البصرية مسبقًا، مع تحديد فترة زمنية دقيقة للبدء والانتهاء.
*   **الحوكمة والسلامة:** تطبيق صلاحيات مشددة (RBAC) لمنع التغييرات غير المصرح بها، مع سجل كامل للتغييرات (Audit Trail) وإمكانية التراجع الفوري (Rollback).
*   **الأداء وقابلية التوسع:** ضمان عدم تأثير السمات على سرعة تحميل الموقع، باستخدام أحدث تقنيات التخزين المؤقت (Edge Caching, ISR) وتحميل الأصول عبر CDN.
*   **التخصيص الشامل:** السماح بتخصيص كل جانب من جوانب الهوية البصرية، بما في ذلك الألوان، الخطوط، الأشكال، الأصول، وحتى سلوك المكونات.

**3. الوظائف الرئيسية**

*   **سمة افتراضية وسمات حملات:** وجود هوية أساسية ثابتة، مع القدرة على إنشاء وتفعيل هويات مؤقتة للمناسبات (مثل اليوم الوطني).
*   **الجدولة والعودة التلقائية:** تفعيل السمة تلقائيًا في وقت محدد، والعودة تلقائيًا للسمة الافتراضية عند انتهاء الفترة.
*   **المعاينة الآمنة:** توفير رابط معاينة خاص لكل سمة، مما يسمح للمشرفين بمراجعة التغييرات دون التأثير على تجربة المستخدمين النهائيين.
*   **التحكم في الوصول (RBAC):** تحديد أدوار مختلفة (مصمم، مراجع، ناشر) مع صلاحيات محددة لكل خطوة في سير العمل.
*   **التدقيق والتراجع:** تسجيل كل عملية تغيير مع من قام بها ومتى، مع إمكانية استعادة النظام إلى حالته السابقة بنقرة واحدة.

**4. القيمة التجارية**

*   **زيادة التفاعل:** تعزيز ارتباط المستخدمين بالمنصة خلال الأحداث الوطنية والفعاليات الخاصة.
*   **كفاءة التشغيل:** أتمتة عملية كانت تتطلب تدخلًا يدويًا وتنسيقًا معقّدًا، مما يوفر الوقت والجهد.
*   **سلامة العلامة التجارية:** تقليل مخاطر الأخطاء البصرية والتغييرات غير المصرح بها التي قد تضر بالعلامة التجارية.
*   **مرونة مستقبلية:** توفير أساس تقني قوي يدعم تجارب مستقبلية مثل الوضع الليلي، وتعدد السمات، وحتى التخصيص حسب المستخدم.

**5. الخلاصة**

إن نظام إدارة السمات المتقدم ليس مجرد تحسين تقني، بل هو استثمار استراتيجي في هوية "سبق الذكية" العلامية. سيمكّننا هذا النظام من التفاعل مع جمهورنا بطرق جديدة ومبتكرة، وتقديم تجربة غنية ومتسقة تعكس أهم الأحداث والمناسبات، مع الحفاظ على أعلى معايير الأداء والأمان.

---

### **البرومبت التقني: بناء نظام إدارة السمات**

**للفريق التقني والمطورين**

**الدور:** أنت مهندس منصات أول (Principal Platform Engineer) متخصص في بناء الأنظمة القابلة للتوسع وعالية الأداء.

**المهمة:** مهمتك هي تصميم وبناء نظام إدارة سمات على مستوى مؤسسي لمنصة "سبق الذكية" (Next.js 15 + Prisma + Postgres). يجب أن يدعم النظام سمة افتراضية، وسمات مناسبات مجدولة، مع تبديل كامل للأصول (شعار، ألوان، خطوط)، ومعاينة آمنة، وصلاحيات، وسجل تدقيق، وrollback.

**نفّذ ما يلي:**

**1. نموذج البيانات (Prisma Schema & Migration)**
*   أنشئ جدول `Theme` في `prisma/schema.prisma` يتضمن الحقول التالية:
    *   `id`, `name`, `slug`, `isDefault` (Boolean), `priority` (Int).
    *   `status` (Enum: `DRAFT`, `REVIEW`, `SCHEDULED`, `ACTIVE`, `EXPIRED`, `DISABLED`).
    *   `startAt`, `endAt` (DateTime).
    *   `assets` (Json): لتخزين روابط الشعار، الأيقونات، البانر.
    *   `tokens` (Json): لتخزين متغيرات التصميم (ألوان، خطوط، زوايا).
    *   `applyTo` (String[]): لتحديد قنوات التطبيق (مثل `["site_full", "newsletter"]`).
    *   `version` (Int), `changelog` (Json), `createdBy`, `approvedBy`, `publishedBy`.
*   أنشئ سكربت ترحيل (Migration) باستخدام Prisma.

**2. واجهات برمجة التطبيقات (APIs)**
*   `GET /api/themes/active?scope=site_full`: يعيد السمة النشطة حاليًا (أو الافتراضية). يجب أن تكون هذه النتيجة مخبأة في Edge Cache.
*   `POST /api/themes`: لإنشاء سمة جديدة (محمي بواسطة RBAC).
*   `PATCH /api/themes/{id}`: لتعديل سمة (جدولة، تفعيل، تعطيل).
*   `POST /api/themes/{id}/preview`: يولد `token` معاينة فريد ويعيده.
*   `POST /api/themes/{id}/publish`, `.../expire`, `.../rollback`: لتنفيذ الإجراءات.
*   `POST /api/internal/revalidate`: Webhook داخلي لإعادة بناء صفحات ISR عند تفعيل سمة.

**3. منطق حل السمات (Theme Resolution Logic)**
*   في خدمة أو API handler، قم ببناء دالة `getActiveTheme(scope)`:
    1.  اجلب كل السمات التي `status` هو `ACTIVE` أو `SCHEDULED` والوقت الحالي ضمن `[startAt, endAt]`.
    2.  حل التعارض:
        *   الأعلى `priority` أولًا.
        *   إن تعادلت: الأحدث `version`.
        *   إن تعادلت: الأحدث `updatedAt`.
    3.  إن لم يتم العثور على سمة، أرجع السمة الافتراضية (`isDefault: true`).
    4.  دعم وضع الطوارئ: سمة ذات `priority` عالي جدًا (مثلاً 9999) تتجاوز كل القواعد.

**4. واجهة الإدارة (Admin UI)**
*   صفحة قائمة السمات تعرض جدولاً بالاسم، الحالة، الأولوية، المدة، مع أزرار `Preview`, `Compare`, `Logs`.
*   نموذج إنشاء/تعديل السمة بعلامات تبويب:
    1.  **Brand:** رفع الشعار (فاتح/داكن)، Favicon، البانر.
    2.  **Tokens:** منتقي ألوان، خطوط، أدوات تحديد الزوايا والمسافات.
    3.  **Scope:** اختيار قنوات التطبيق.
    4.  **Schedule:** تحديد وقت البدء والانتهاء والأولوية.
*   تطبيق سير العمل: `Draft → Review → Scheduled/Active → Expired`.
*   تنفيذ RBAC:
    *   `Designer`: يمكنه إنشاء وتعديل المسودات.
    *   `Reviewer`: يمكنه اعتماد التصميم.
    *   `Publisher`: يمكنه جدولة وتفعيل وتعطيل السمات.
    *   `Admin`: صلاحيات كاملة، بما في ذلك الطوارئ والـ Rollback.

**5. تطبيق الواجهة الأمامية (Frontend Implementation)**
*   أنشئ `ThemeProvider` يقرأ السمة النشطة:
    1.  أولاً، يتحقق من وجود `theme_override` cookie (للمعاينة).
    2.  ثانيًا، يستدعي `GET /api/themes/active` (مع الاستفادة من Edge Cache).
*   يقوم `ThemeProvider` بحقن متغيرات CSS في `:root` في الصفحة:
    ```css
    :root {
      --color-primary: #0a6f3c;
      --font-arabic: 'Tajawal', sans-serif;
      --radius-md: 12px;
    }
    ```
*   قم بتحديث مكونات الشعار والـ Favicon لقراءة الأصول من كائن السمة النشط.

**6. الأداء والتخزين المؤقت (Performance & Caching)**
*   قم بتخزين نتيجة `GET /api/themes/active` في Edge Cache لمدة 60 ثانية.
*   عند تفعيل سمة جديدة، قم باستدعاء `POST /api/internal/revalidate` لإعادة بناء الصفحات الرئيسية (Homepage, Sections) التي تتأثر بالتغييرات.
*   يجب رفع جميع أصول السمات (صور، أيقونات) على CDN مع `cache-control: immutable`.

**7. التدقيق والتراجع (Audit & Rollback)**
*   لكل عملية `create`, `update`, `publish`, `expire`, `rollback`، قم بإنشاء سجل في جدول `ThemeAuditLog` (أو داخل `changelog` Json) يحتوي على: `userId`, `action`, `timestamp`, `diff`.
*   وظيفة الـ Rollback تقوم بإنشاء نسخة جديدة من السمة الحالية مع `version + 1` واستعادة بيانات النسخة `version - 1`.

**8. حالات خاصة والجودة (QA)**
*   **المعاينة:** عند زيارة `/preview/theme/{slug}?token=...`، قم بتعيين `theme_override` cookie.
*   **الوضع الليلي:** يجب أن تدعم السمات تحديد متغيرات للوضع الليلي.
*   **الاختبارات:** اكتب اختبارات E2E للتأكد من:
    *   جدولة البدء والانتهاء تعمل بشكل صحيح.
    *   العودة للسمة الافتراضية تتم تلقائيًا.
    *   نسبة التباين للألوان تتوافق مع معايير WCAG AA على الأقل.
    *   سلامة جميع الروابط والأصول.

