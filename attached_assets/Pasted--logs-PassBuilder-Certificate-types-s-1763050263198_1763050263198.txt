## ğŸ¯ **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ**

Ø§Ù„Ù€ logs ØªÙØ¸Ù‡Ø± **ØªÙ‚Ø¯Ù… ÙƒØ¨ÙŠØ±**:
```
ğŸ” [PassBuilder] Certificate types: { signerCert: 'string', signerKey: 'string', wwdr: 'string' }
```

**Ù„ÙƒÙ† Ø§Ù„Ø®Ø·Ø£ ÙŠØ¨Ù‚Ù‰**: `"wwdr" is required` Ù…Ø¹ Ø£Ù† Ø§Ù„Ù€ property Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ§Ù„Ù†ÙˆØ¹ ØµØ­ÙŠØ­!

### **Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ**

Ù…ÙƒØªØ¨Ø© `passkit-generator` ØªØ³ØªØ®Ø¯Ù… **Joi validation** Ø¨Ø¯Ù‚Ø© Ø´Ø¯ÙŠØ¯Ø©. Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù‚ÙŠÙ…Ø© `string`ï¼Œ Ø¥Ø°Ø§ **Ø§Ù„Ù…Ø­ØªÙˆÙ‰** Ù„Ø§ ÙŠØ·Ø§Ø¨Ù‚ **Ù†Ù…Ø· PEM Ø§Ù„ØµØ­ÙŠØ­** Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŒ ØªØ¹Ø§Ù…Ù„Ù‡ ÙƒØ£Ù†Ù‡ `undefined` Ø£Ùˆ `invalid` ÙˆØªÙØ·Ù„Ù‚ `"any.required"` error.

**Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠ Ø§Ù„Ù€ PEM string:**
1. **Ø¥Ø¶Ø§ÙØ§Øª Ø²Ø§Ø¦Ø¯Ø©**: Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†ØµÙŠØµ (`"`), Ù…Ø³Ø§ÙØ§Øª Ø²Ø§Ø¦Ø¯Ø©ØŒ Ø£Ø³Ø·Ø± ÙØ§Ø±ØºØ©
2. **BOM character**: Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø®ÙÙŠ `0xFEFF` ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù†Øµ
3. **Line endings Ø®Ø§Ø·Ø¦Ø©**: `\r\n` (Windows) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† `\n` (Unix)
4. **Base64 encoding Ø®Ø§Ø·Ø¦**: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø¹Ø¯ ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ù„Ø§ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ `-----BEGIN CERTIFICATE-----`

---

## âœ… **Ø§Ù„Ø­Ù„ Ø§Ù„ÙÙˆØ±ÙŠ ÙˆØ§Ù„Ù…Ø¶Ù…ÙˆÙ†**

### **1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…**

ÙÙŠ `PassKitService.ts`ØŒ Ø£Ø¶Ù Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„Ø©:

```typescript
private cleanPemCertificate(base64Input: string): string {
  // 1. Decode from base64
  const decoded = Buffer.from(base64Input.trim(), 'base64').toString('ascii');
  
  // 2. Remove BOM if exists
  const bomless = decoded.charCodeAt(0) === 0xFEFF ? decoded.slice(1) : decoded;
  
  // 3. Normalize line endings to Unix format
  const normalized = bomless.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  
  // 4. Remove extra quotes if present
  const unquoted = normalized.replace(/^"|"$/g, '');
  
  // 5. Trim whitespace
  const trimmed = unquoted.trim();
  
  // 6. Validate PEM format (check for BEGIN/END markers)
  if (!trimmed.includes('-----BEGIN CERTIFICATE-----')) {
    throw new Error(`Invalid PEM format: Missing certificate header`);
  }
  if (!trimmed.includes('-----END CERTIFICATE-----')) {
    throw new Error(`Invalid PEM format: Missing certificate footer`);
  }
  
  // 7. Ensure proper line breaks (64 chars per line for content)
  // This is optional but recommended for strict parsers
  const header = trimmed.match(/-----BEGIN[^-]+-----/)![0];
  const footer = trimmed.match(/-----END[^-]+-----/)![0];
  const content = trimmed
    .replace(/-----BEGIN[^-]+-----/, '')
    .replace(/-----END[^-]+-----/, '')
    .replace(/\s/g, '');
  
  const formattedContent = content.match(/.{1,64}/g)?.join('\n') || content;
  
  return `${header}\n${formattedContent}\n${footer}\n`;
}

private loadCertificates(): Certificates {
  try {
    const wwdr = this.cleanPemCertificate(process.env.APPLE_WWDR_CERT!);
    const signerCert = this.cleanPemCertificate(process.env.APPLE_LOYALTY_PASS_CERT!);
    
    // For private key, the type might be "PRIVATE KEY" or "RSA PRIVATE KEY"
    const signerKeyRaw = Buffer.from(process.env.APPLE_LOYALTY_PASS_KEY!.trim(), 'base64').toString('ascii');
    const signerKey = this.cleanPrivateKey(signerKeyRaw);
    
    console.log('âœ… [PassKit] Certificates cleaned and validated');
    
    // Log preview (first 50 chars) for debugging
    console.log(`ğŸ” [PassKit] WWDR preview: ${wwdr.substring(0, 50)}...`);
    
    return {
      wwdr,
      signerCert,
      signerKey,
      signerKeyPassphrase: process.env.APPLE_PASS_KEY_PASSPHRASE
    };
  } catch (error) {
    console.error('âŒ [PassKit] Certificate loading failed:', error);
    throw error;
  }
}

private cleanPrivateKey(pem: string): string {
  const cleaned = pem
    .replace(/\r\n/g, '\n')
    .replace(/\r/g, '\n')
    .trim();
  
  // Check for either PKCS#8 or PKCS#1 format
  const hasPkcs8 = cleaned.includes('-----BEGIN PRIVATE KEY-----');
  const hasPkcs1 = cleaned.includes('-----BEGIN RSA PRIVATE KEY-----');
  
  if (!hasPkcs8 && !hasPkcs1) {
    throw new Error('Invalid private key format: Must be PKCS#1 or PKCS#8');
  }
  
  return cleaned;
}
```

### **2. Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ PassBuilder**

Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ `PKPass`ï¼ŒØ£Ø¶Ù logging ÙŠÙØ¸Ù‡Ø± **Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙØ¹Ù„ÙŠ** (Ø£ÙˆÙ„ 50 Ø­Ø±Ù):

```typescript
async generatePass(userData: any) {
  try {
    const certificates = this.passKitService.loadCertificates();
    
    // Critical debugging log
    console.log('ğŸ” [PassBuilder] WWDR content check:', {
      startsWith: certificates.wwdr.substring(0, 30),
      hasNewlines: certificates.wwdr.includes('\n'),
      length: certificates.wwdr.length,
      isValidPem: certificates.wwdr.includes('-----BEGIN CERTIFICATE-----')
    });
    
    const pass = await PKPass.from({
      model: this.model,
      certificates: certificates,
      // ... rest of options
    });
    
    return pass;
  } catch (error) {
    console.error('âŒ [PassBuilder] PKPass creation failed:', error.message);
    throw error;
  }
}
```

---

## ğŸ”§ **Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø±ÙŠØ¹Ø©**

### **ÙÙŠ Replit/Glitch:**

1. **Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù€ Secrets**:
   - ØªØ£ÙƒØ¯ Ø£Ù† ÙƒÙ„ certificate Ù…Ø­ÙÙˆØ¸ **ÙƒÙ€ base64 string ÙˆØ§Ø­Ø¯ Ø³Ø·Ø±** (Ø¨Ø¯ÙˆÙ† Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø©)
   - Ù„Ø§ ØªØ¶Ù Ø¹Ù„Ø§Ù…Ø§Øª ØªÙ†ØµÙŠØµ `"` Ø­ÙˆÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø©

2. **Ø£Ø¹Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡**:
```bash
npm run build
```

3. **Ø£Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„** (Restart machine)

4. **ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ logs Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©**:
```
âœ… [PassKit] Certificates cleaned and validated
ğŸ” [PassKit] WWDR preview: -----BEGIN CERTIFICATE-----
ğŸ” [PassBuilder] WWDR content check: {
  startsWith: '-----BEGIN CERTIFICATE-----',
  hasNewlines: true,
  length: 1561,
  isValidPem: true
}
âœ… PKPass generated successfully!
```

---

## âš ï¸ **Ø§Ù„Ù†ÙˆØ¹ÙŠÙ† Ø§Ù„Ø´Ø§Ø¦Ø¹ÙŠÙ† ÙˆØ­Ù„ÙˆÙ„Ù‡Ù… Ø§Ù„Ø³Ø±ÙŠØ¹Ø©**

### **Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 1: Base64 ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ `\n` Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©**
Ø¥Ø°Ø§ Ù†Ø³Ø®Øª Ø§Ù„Ù€ certificate ÙŠØ¯ÙˆÙŠØ§Ù‹ØŒ Ø±Ø¨Ù…Ø§ Ø£Ø¯Ø®Ù„Øª Ø£Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù€ value.

**Ø§Ù„Ø­Ù„**:
```bash
# ÙÙŠ terminalØŒ Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù€ PEM Ø¥Ù„Ù‰ base64 Ø³Ø·Ø± ÙˆØ§Ø­Ø¯
cat certificate.pem | base64 | tr -d '\n'
```

### **Ø§Ù„Ù…Ø´ÙƒÙ„Ø© 2: Ø§Ù„Ù€ PEM ÙÙŠ Ø§Ù„Ù€ Env Var Ù„ÙŠØ³ base64**
Ø±Ø¨Ù…Ø§ ØªÙƒÙˆÙ† Ø­Ø§ÙØ¸ Ø§Ù„Ù€ PEM Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ø¹ `\n`) ÙÙŠ Ø§Ù„Ù€ env var.

**Ø§Ù„Ø­Ù„**:
- Ø¥Ù…Ø§ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ PEM Ø¥Ù„Ù‰ base64 Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
- Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙŠÙ‚Ø±Ø£Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©:
```typescript
// Ø¥Ø°Ø§ Ø§Ù„Ù€ env var Ù‡Ùˆ PEM Ù…Ø¨Ø§Ø´Ø± (multiline)
const wwdrPem = process.env.APPLE_WWDR_CERT!.replace(/\\n/g, '\n');
```

---

## ğŸš€ **Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù†Ùƒ**

1. **Ø£Ø±Ø³Ù„ Ù„ÙŠ** Ù…Ø­ØªÙˆÙ‰ `process.env.APPLE_WWDR_CERT?.substring(0, 100)` (Ø£ÙˆÙ„ 100 Ø­Ø±Ù) Ù„Ø£Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† ØµØ­ÙŠØ­
2. **Ø£Ø±Ø³Ù„ Ù„ÙŠ** Ù†ØªÙŠØ¬Ø© Ù‡Ø°Ø§ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯:
```typescript
console.log('DEBUG:', JSON.stringify(certificates.wwdr).substring(0, 100));
```
3. **Ø£ÙƒØ¯ Ù„ÙŠ** Ø¥Ù†Ùƒ Ø¹Ù…Ù„Øª `npm run build` Ùˆ `restart` Ø¨Ø¹Ø¯ Ø¢Ø®Ø± ØªØºÙŠÙŠØ±

Ø¥Ø°Ø§ Ø§Ù„ØªÙ†ÙÙŠØ° Ø£Ø¹Ù„Ø§Ù‡ Ù…Ø§ Ø²Ø§Ù„ ÙŠÙØ´Ù„ØŒ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† ÙÙŠ **Ù†Ø³Ø®Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©** Ø£Ùˆ **Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©** Ù„Ù„Ù€ validation schema. Ø³Ø£Ø­ØªØ§Ø¬ Ø£Ø±Ù‰ `package.json` Ù„Ø£Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø±.