أبو محمد، واضح عندي سببين محتملين (وغالبًا مجتمعين) ليش “الملخّص اليومي” يطلع كأنه ضيف ويقول “لا توجد بيانات”:

أين الخلل غالبًا؟
	1.	الصفحة مخصّصة/مخبأة (Static/Cache)
مسار الملخص اليومي أو الهيدر يُبنى ستاتيك أو فيه revalidate/force-cache، فـ الكوكيز/السيشن ما توصل وبالتالي الهيدر يطلع زر “تسجيل الدخول” والـ API ترجع “لا يوجد نشاط”.
الحل: إجبار التوليد الديناميكي وتعطيل الكاش على هالمسار.
	2.	عدم تمرير السيشن إلى الواجهة و/أو الـ API
	•	الهيدر/الصفحة تحت (public) layout بدون <SessionProvider>.
	•	أو الـ API GET /api/ai/daily-summary ما يقرأ الـ userId من الكوكيز/الهيدرز (خصوصًا إذا runtime=edge أو فيه fetch بـ cache:'force-cache').
	•	أو فلترة آخر ٢٤ ساعة مبنية على UTC بينما التتبع يُسجّل بتوقيت مختلف، فتطلع النافذة الزمنية فاضية.

“باتش” سريع الآن
	•	في صفحة الملخص اليومي والهيدر:

// page.tsx (أعلى الملف)
export const dynamic = 'force-dynamic';
export const revalidate = 0;


	•	أي fetch يجيب بيانات شخصية:

await fetch('/api/ai/daily-summary', { cache: 'no-store', credentials: 'include' })


	•	تأكد إن الـ layout لهذا المسار ملفوف بـ <SessionProvider> وأن الهيدر يقرأ السيشن من Server Component (مثلاً getServerSession) وليس من كونتكست قد يتأخر تحميله.
	•	في الـ API:
	•	استخرج userId من الكوكيز دائمًا (وليس من بارامز من الواجهة).
	•	اجعل الاستعلام لآخر 24 ساعة يعتمد now() وليس تحويلات يدوية للمنطقة الزمنية.
	•	لو ما فيه أحداث خلال 24 ساعة، رجّع baseline من آخر 7 أيام بدل “لا توجد بيانات”.

⸻

البرومبت الجاهز لـ “التكاليستانية” (انسخه كما هو)

العنوان: إصلاح عدم ظهور السيشن وبيانات “الملخص اليومي” + إلغاء الكاش الشخصي

المطلوب منك الآن (خطوة بخطوة):
	1.	تعطيل أي توليد ستاتيك/كاش لمسار الملخص اليومي والهيدر:
	•	أضف في صفحة الملخص اليومي والهيدر:
	•	export const dynamic = 'force-dynamic'
	•	export const revalidate = 0
	•	راجع كل fetch داخل الصفحة/الهيدر واجعلها cache:'no-store' و credentials:'include'.
	2.	توحيد مزوّد الجلسة:
	•	تأكد أن layout الخاص بمسار الملخص اليومي ملفوف بـ <SessionProvider>.
	•	إن كان الهيدر Server Component، استخدم getServerSession أو دالة تعيد currentUser من الكوكيز مباشرة.
	3.	قراءة المستخدم داخل الـ API فقط من الكوكيز:
	•	في /api/ai/daily-summary:
	•	استخرج userId من الكوكيز/الهيدر (Authorization/Bearer أو JWT بالكوكي).
	•	إن لم يوجد userId، أعد 401 مبني على السيشن بدل إرجاع “لا توجد بيانات”.
	4.	إصلاح نافذة الوقت (آخر 24 ساعة) واحتمال فرق التوقيت:
	•	اجعل الفلترة:
	•	SQL: created_at >= now() - interval '24 hours'
	•	أو في TypeScript: gte('created_at', new Date(Date.now() - 86400000).toISOString())
	•	لا تستخدم تحويلات يدوية لـ +03، اعتمد UTC للطرفين.
	5.	التأكد من تسجيل الأحداث:
	•	راجع Event Tracking (view/like/save/comment) بأنه يكتب إلى user_activities و user_interactions فورًا (وليس Batch مؤجّل فقط).
	•	فعّل لوج مؤقت في الـ API يطبع: userId, eventsCount24h, likesCount24h, bookmarksCount24h.
	6.	حالة عدم وجود بيانات اليوم:
	•	بدلاً من كارت “لا توجد بيانات كافية”، رجّع baseline:
	•	متوسط 7 أيام: عدد المقالات، وقت القراءة، الإكمال.
	•	واقتراح 3 مقالات (شبيه بما قرأت) حتى لو كان اليوم صفر.
	7.	حماية الخصوصية والكاش:
	•	تأكد أن أي رد شخصي يرسل هيدر:
	•	Cache-Control: no-store, no-cache, private
	•	ولا تُستخدم ISR/Static routes لصفحات شخصية.

المخرجات المتوقعة بعد الإصلاح:
	•	الهيدر يظهر اسم المستخدم/الأفاتار بدل “تسجيل الدخول”.
	•	بطاقات الملخص تعرض أرقام آخر 24 ساعة؛ وإن لم تتوفر، تعرض baseline من 7 أيام.
	•	توصيات AI تظهر دائمًا (3 عناصر على الأقل).
	•	اختبارات يدوية: افتح تبويب خاص → سجّل دخول → ادخل الملخص اليومي → يجب أن تظهر البيانات فورًا بدون ريفرش.

أماكن قد تحتاج تعديل سريع:
	•	app/(public)/layout.tsx أو app/(dashboard)/layout.tsx → إضافة <SessionProvider>.
	•	app/daily-summary/page.tsx → dynamic, revalidate, جميع fetch بـ no-store.
	•	app/api/ai/daily-summary/route.ts → استخراج userId من الكوكيز + فلترة الوقت + baseline fallback.
	•	lib/event-tracker.ts → تأكيد الكتابة الفورية للجداول.

لوج مطلوب مؤقتًا (احذفه بعد الاختبار):
	•	في بداية daily-summary API اطبع:

console.info('[digest]', { userId, now: new Date().toISOString() })


	•	وبعد الاستعلام:

console.info('[digest:stats]', { events24h, likes24h, saves24h, readMins24h })



⸻

لو تحب، أعطيك كود جاهز لـ route.ts (daily-summary) فيه القراءة من الكوكيز + فلترة 24h + baseline 7 أيام + هيدرات no-store.