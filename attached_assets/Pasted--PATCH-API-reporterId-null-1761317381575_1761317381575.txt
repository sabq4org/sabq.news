أبو محمد، واضح من اللوجز إن الـPATCH ما يرسل أي قيمة لحقل المراسل، لذلك الـAPI تحفظ reporterId: null فيرجع الخبر يظهر باسم مسؤول النظام (الكاتب الافتراضي). الدليل: [UPDATE ARTICLE] Update data: { reporterId: null, ... } وبعدها authorId: 'admin-sabq'. فالخلل غالبًا ربط الواجهة + الـDTO في الـAPI، وليس في الصلاحيات.

خلّيني أعطيك fix عملي “جاهز للتطبيق” من الـDB إلى الواجهة:

1) قاعدة البيانات / Prisma (لو العمود غير موجود)

أضِف علاقة مراسل للمقال (nullable، مع FK):

// schema.prisma
model Article {
  id          String   @id @default(uuid())
  title       String
  content     String
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])

  reporterId  String?           // <— مفتاح أجنبي اختياري
  reporter    Reporter? @relation(fields: [reporterId], references: [id])

  status      ArticleStatus @default(DRAFT)
  publishedAt DateTime?
  // ... بقية الحقول
}

model Reporter {
  id        String   @id @default(uuid())
  userId    String?
  fullName  String
  slug      String   @unique
  // ...
  articles  Article[]
}

ترحيل SQL (لو تعملها يدويًا):

ALTER TABLE articles ADD COLUMN IF NOT EXISTS reporter_id TEXT;
ALTER TABLE articles
  ADD CONSTRAINT fk_articles_reporter
  FOREIGN KEY (reporter_id) REFERENCES reporters(id)
  ON DELETE SET NULL;
CREATE INDEX IF NOT EXISTS idx_articles_reporter ON articles(reporter_id);

ملاحظة: لو تستخدم snake_case بالـDB وcamelCase بالتطبيق، فعِّل mapping في Prisma أو سوِّ وحدة تحويل بالأAPI.

2) عقدة الـAPI (PATCH /api/admin/articles/[id])

تأكد أن الـAPI تتوقع وتُحدّث reporterId، وتتحقق من وجود المراسل:

// app/api/admin/articles/[id]/route.ts
import { z } from "zod";
import { prisma } from "@/lib/prisma";

const UpdateArticleSchema = z.object({
  title: z.string().optional(),
  content: z.string().optional(),
  // مهم:
  reporterId: z.string().uuid().nullable().optional(),
  // ... أي حقول أخرى
});

export async function PATCH(req: Request, { params }: { params: { id: string } }) {
  const body = await req.json();
  const input = UpdateArticleSchema.parse(body);

  // لو وصل reporterId، تحقّق من وجوده، أو اسمح بـnull لمسح المراسل
  if (typeof input.reporterId !== "undefined" && input.reporterId !== null) {
    const exists = await prisma.reporter.findUnique({ where: { id: input.reporterId } });
    if (!exists) {
      return new Response(JSON.stringify({ error: "Reporter not found" }), { status: 400 });
    }
  }

  const updated = await prisma.article.update({
    where: { id: params.id },
    data: {
      ...("title" in input ? { title: input.title } : {}),
      ...("content" in input ? { content: input.content } : {}),
      ...( "reporterId" in input ? { reporterId: input.reporterId ?? null } : {} ),
    },
    include: { reporter: true, author: true },
  });

  // لوج مفيد للتأكد:
  console.log("[UPDATE ARTICLE] Update data:", { reporterId: updated.reporterId });

  return Response.json(updated);
}

عندك في اللوج الحالي الـAPI تطبع reporterId: null، فهذا يعني إن الجسم القادم من الواجهة ما فيه الحقل أصلاً أو انمسح قبل الإرسال.

3) واجهة التحرير (React / Next.js)

(أ) اجلب قائمة المراسلين واعرضها في Select

// داخل محرر المقال
const [reporters, setReporters] = useState<{value: string; label: string}[]>([]);
const [form, setForm] = useState<{ title: string; content: string; reporterId: string | null }>({
  title: article.title,
  content: article.content,
  reporterId: article.reporter?.id ?? null, // مهم: تهيئة القيمة الابتدائية
});

useEffect(() => {
  fetch("/api/admin/reporters")
    .then(r => r.json())
    .then((items) => setReporters(items.map((r: any) => ({ value: r.id, label: r.fullName }))));
}, []);

(ب) عنصر الاختيار (مضبوط ومتحكَّم فيه)

<Select
  options={reporters}
  value={reporters.find(r => r.value === form.reporterId) ?? null}
  onChange={(opt) => setForm(prev => ({ ...prev, reporterId: opt ? opt.value : null }))}
  isClearable
  placeholder="اختر المراسل"
/>

(ج) الإرسال — تأكّد أن reporterId موجود في الـPATCH

async function handleSave() {
  const payload = {
    title: form.title,
    content: form.content,
    // أهم سطرين:
    reporterId: form.reporterId,           // <— لازم يروح في البودي
  };

  const res = await fetch(`/api/admin/articles/${article.id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const data = await res.json();
  console.log("Saved:", data);
}

خطأ شائع: تخزين كائن المراسل كاملًا في الحالة (reporter: {...}) دون حفظ reporterId، ثم نسيان استخراج الـid عند الإرسال. أو أن onChange يحدث state آخر غير المُرسَل.

4) عرض اسم الكاتب في الواجهة العامة (Byline)

اجعل الاستدعاء يُضمّن الكاتب والمراسل، ثم فضّل المراسل عند العرض:

// API القراءة
const article = await prisma.article.findUnique({
  where: { id },
  include: { reporter: true, author: true },
});

// في واجهة القراءة
const byline = article.reporter?.fullName ?? article.author?.name ?? "بدون اسم";

5) مسارات/جهات قد تكسر الربط
	•	اختلاف التسمية بين reporterId في الواجهة و reporter_id في الـDB: عالجها في Prisma أو طبقة الـAPI.
	•	Zod schema لا يحتوي reporterId → تُهمل القيمة حتى لو أرسلتها الواجهة.
	•	Form state يُعاد تهيئته بعد الـsave (hydration) فيختفي الاختيار — تأكد من إعادة قراءة المقال بعد الحفظ أو تحديث الحالة بقيمة الـresponse.
	•	كاش الـSWR/React Query: اعمل mutate للمفتاح /api/dashboard/articles/[id] بعد الحفظ.
	•	صلاحيات: تأكد أن أدوار admin/editor مسموح لهم تحديث reporterId في middleware التفويض (RBAC).

6) تشيك لست سريعة (دقيقتين من المتصفح)
	1.	من Network تبويب → افتح PATCH عند الضغط “حفظ”، وشوف Request Payload: هل يحتوي reporterId: "xxxx-..."؟
	2.	لو كان مفقود: راجع onChange للـSelect + جسم الـpayload.
	3.	لو موجود: راجع لوج الـAPI قبل parse/validate وبعدها — هل الـschema ترمي الحقل؟
	4.	لو وصل للـAPI ويحفظ null: تأكد من تحقق وجود المراسل + سطر data: { reporterId: input.reporterId ?? null }.

⸻

Hotfix فوري (لو تبغى تمشيها الآن بسرعة)
	•	في الـAPI، قبل التحديث، جرّب طباعة req.json() كامل، وتأكد إن فيه reporterId.
	•	لو الواجهة الحالية ترسل reporter بدل reporterId، أضِف تحويل مؤقت:

const raw = await req.json();
const body = { ...raw, reporterId: raw.reporter?.id ?? raw.reporterId ?? null };

ثم طبّق التحقق والحفظ كما بالأعلى.

⸻

إذا ودّك، أكتب لك PR صغير (front + api) فيه كل التعديلات بالأعلى بأسلوب متوافق مع Next.js 15 + TypeScript + Prisma، ونهيّئ لوج إضافي يطبع reporterId قبل/بعد الحفظ عشان ننهي المشكلة من جذورها.