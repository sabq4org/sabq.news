تمام يا أبو محمد ✅
جهّزت لك “برمبت نصّي” واحد شامل — تلصقه في أداة الـAI/Agent عندكم (أو ترسله للفريق) عشان يبني/يحدّث نظام الإعلانات الداخلية في لوحة التحكم من إعلان واحد إلى نظام كامل متعدد الإعلانات مع أرشيف، وباسم قائمة “التواصل الداخلي” تحت الإعدادات.

⸻

برمبت نصّي لتنفيذ “نظام الإعلانات الداخلية” في لوحة التحكم

الدور/Role: أنت مطوّر Full-Stack (Next.js 15 + TypeScript + Prisma + Supabase + Tailwind + Radix UI + shadcn/ui) تبني ميزة “الإعلانات الداخلية” للـCMS العربي “سبق الذكية”.

الهدف/Goal: تحويل نظام الإعلان الداخلي من عنصر واحد إلى نظام متكامل يتيح:
	1.	إنشاء عدة إعلانات داخلية.
	2.	جدولة النشر وتحديد المدة والحالة.
	3.	أرشيف كامل بكل النسخ والتعديلات (Versioning).
	4.	تصفية/بحث وتحليلات بسيطة للمشاهدة/التفاعل.
	5.	صلاحيات واضحة (من يمكنه الإنشاء/النشر/الأرشفة).
	6.	ظهور قسم جديد في القائمة اليمنى باسم: التواصل الداخلي تحت الإعدادات.

⸻

المتطلبات الوظيفية (Functional)
	1.	إنشاء عدة إعلانات
	•	الحقول الأساسية: title, message, priority (low|normal|high), audience (all|role[]|userId[]), channels (dashboardBanner|inbox|toast), attachments[], tags[].
	•	الحالة: draft | scheduled | published | expired | archived.
	•	التواريخ: startAt, endAt (اختياريان).
	•	إعدادات الظهور: dismissible (boolean), maxViewsPerUser (number|null).
	2.	الأرشيف والنسخ (Versioning & History)
	•	كل تعديل ينشئ نسخة مع: changedBy, changedAt, diff.
	•	صفحة “أرشيف الإعلانات” مع فلاتر: الحالة، المدة، القنوات، الكلمات المفتاحية، الوسوم.
	3.	الاستهداف (Targeting)
	•	حسب الأدوار (RBAC): system_admin, admin, editor, reporter, media, trainee, …
	•	الاستهداف المباشر لمستخدمين محددين (IDs).
	•	الاستهداف بقسم/فريق (اختياري لاحقًا).
	4.	التحليلات الخفيفة
	•	تسجيل impressions, uniqueViews, dismissals, clickThroughs لكل إعلان.
	•	لوحة مصغرة تعرض أفضل 10 إعلانات من حيث الوصول خلال فترة محددة.
	5.	التنبيهات
	•	عند نشر إعلان “أولوية عالية”، إشعار داخلي لفئات محددة (حسب audience) في مركز الإشعارات داخل اللوحة.
	•	دعم Channel inbox (صندوق وارد داخلي بسيط).
	6.	الصلاحيات
	•	system_admin وadmin: إنشاء/تحرير/نشر/أرشفة/حذف.
	•	editor: إنشاء/تحرير مسودة، واقتراح للنشر.
	•	غيرهم: قراءة فقط إذا كانوا ضمن الجمهور المستهدف.
	7.	القائمة والصفحات
	•	أضف قسمًا في القائمة اليمنى تحت الإعدادات بعنوان التواصل الداخلي ويحتوي:
	•	“الإعلانات” (قائمة + إنشاء جديد)
	•	“أرشيف الإعلانات”
	•	“تحليلات الإعلانات” (بسيطة)

⸻

مخطط قاعدة البيانات (Prisma Schema – مقترح)

model InternalAd {
  id                String   @id @default(uuid())
  title             String
  message           String   // HTML/JSON (rich text)
  priority          AdPriority @default(NORMAL)
  status            AdStatus   @default(DRAFT)
  channels          Json      // string[]: ["dashboardBanner","inbox","toast"]
  audienceRoles     Json?     // string[] of roles
  audienceUserIds   Json?     // string[] of user IDs
  tags              Json?     // string[] of keywords
  attachments       Json?     // {url:string,name:string,type:string}[]
  dismissible       Boolean   @default(true)
  maxViewsPerUser   Int?
  startAt           DateTime?
  endAt             DateTime?
  createdById       String
  updatedById       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  versions          InternalAdVersion[]
  metrics           InternalAdMetric[]
  @@index([status, startAt, endAt])
}

model InternalAdVersion {
  id           String   @id @default(uuid())
  adId         String
  title        String
  message      String
  changedById  String
  changedAt    DateTime @default(now())
  diff         Json?
  ad           InternalAd @relation(fields: [adId], references: [id], onDelete: Cascade)
  @@index([adId, changedAt])
}

model InternalAdMetric {
  id           String   @id @default(uuid())
  adId         String
  userId       String?
  event        AdEvent  // IMPRESSION | UNIQUE_VIEW | DISMISS | CLICK
  at           DateTime @default(now())
  meta         Json?
  ad           InternalAd @relation(fields: [adId], references: [id], onDelete: Cascade)
  @@index([adId, event, at])
}

enum AdPriority { LOW NORMAL HIGH }
enum AdStatus   { DRAFT SCHEDULED PUBLISHED EXPIRED ARCHIVED }
enum AdEvent    { IMPRESSION UNIQUE_VIEW DISMISS CLICK }


⸻

واجهات الـAPI (Next.js API Routes)
	•	POST   /api/internal-ads  إنشاء إعلان
	•	GET    /api/internal-ads  قائمة مع فلاتر (status, q, tags, channel, date range, priority, role)
	•	GET    /api/internal-ads/:id قراءة إعلان
	•	PATCH  /api/internal-ads/:id تعديل + إنشاء نسخة في InternalAdVersion
	•	POST   /api/internal-ads/:id/publish تغيير الحالة إلى PUBLISHED (مع تحقق الصلاحيات)
	•	POST   /api/internal-ads/:id/archive الحالة ARCHIVED
	•	DELETE /api/internal-ads/:id حذف ناعم (اختياري)
	•	POST   /api/internal-ads/:id/metrics تسجيل حدث (impression, click, dismiss)
	•	حراسة زمنية/Scheduler: Cron/Queue لتبديل الحالة تلقائيًا إلى PUBLISHED عند startAt، وإلى EXPIRED بعد endAt.

التحقق (Zod): امنع رسائل فارغة، حد أقصى للحروف، تأكد من صلاحيات الناشر، وتحقق من منطق التواريخ.

⸻

الواجهة (UI/UX)
	•	التقنيات: Next.js 15 + TypeScript + Tailwind + Radix UI + shadcn/ui + Framer Motion (RTL بالكامل).
	•	شاشة “قائمة الإعلانات”: جدول مع أعمدة (العنوان، الحالة، القنوات، المدة، الأولوية، تم الإنشاء بواسطة، آخر تحديث).
	•	عمليات سريعة: Create / Edit / Duplicate / Archive.
	•	فلاتر علوية + بحث فوري + وسوم قابلة للنقر.
	•	نموذج الإنشاء/التحرير:
	•	Tabs: المحتوى | الاستهداف | النشر والجدولة | المرفقات.
	•	محرر نص منسّق (Tiptap/Editor.js) مع عدّاد أحرف وتنبيه عند الأولوية العالية.
	•	اختيار القنوات (CheckboxGroup).
	•	الاستهداف (أدوار متعددة + Users اختياري).
	•	الجدولة (startAt/endAt) + زر نشر الآن.
	•	معاينة (Preview) قبل النشر.
	•	لافتة العرض داخل الـDashboard:
	•	تحترم audience وchannels.
	•	قابلة للإخفاء إذا dismissible=true وتسجيل الحدث.
	•	صفحة الأرشيف:
	•	Timeline للنسخ، زر “استرجاع نسخة” ينشئ نسخة جديدة بالمحتوى القديم (لا يكتب فوقًا).
	•	صفحة التحليلات:
	•	Cards: إجمالي الوصول، المشاهدات الفريدة، أعلى الإعلانات أداءً، القنوات الأكثر فاعلية.

إتاحة الوصول (Accessibility): تباين ألوان كافٍ، أزرار واضحة، دعم لوحة المفاتيح، رسائل حالة ناطقة (aria-live).

⸻

السيكوريتي والمراجعة (Security & Audit)
	•	وكل استدعاء تعديل يسجل في activity_logs مع old_value/new_value.
	•	تحجيم المعدل (Rate-limit) لنقاط نشر/أرشفة.
	•	التزام RBAC بدقّة في كل Endpoint.
	•	التحقق من المرفقات (أنواع آمنة، حجم مناسب).

⸻

الهجرة (DB Migration) وخطوات الدمج
	1.	إنشاء جداول InternalAd, InternalAdVersion, InternalAdMetric.
	2.	ربط RBAC في الـAPI.
	3.	إضافة عنصر القائمة: الإعدادات → التواصل الداخلي.
	4.	زرع بيانات أولية (Seed) بإعلانين توضيحيين (LOW وHIGH).
	5.	إضافة Cron/Job لجدولة النشر/الانتهاء.
	6.	إضافة مكونات الواجهة (قائمة + نموذج + أرشيف + تحليلات).
	7.	إدراج اللافتة في /admin/dashboard إذا كان المستخدم ضمن الجمهور.

⸻

معايير القبول (Acceptance Criteria)
	•	يمكن إنشاء أكثر من إعلان، ونشره الآن أو جدولته.
	•	يظهر قسم التواصل الداخلي تحت الإعدادات وفيه: (الإعلانات، الأرشيف، التحليلات).
	•	الأرشيف يعرض كل النسخ ويُمكّن الاسترجاع بنسخة جديدة.
	•	التحليلات تعرض الأرقام الأساسية وتتحدث فورياً.
	•	RBAC مطبق: فقط Admin/SystemAdmin ينشر/يؤرشف.
	•	لافتات الإعلانات تظهر/تختفي حسب audience, channels, time window.
	•	اختبارات وحدة/تكامل أساسية لواجهات API والمنطق الزمني.

⸻

JSON مثال لكائن إعلان

{
  "title": "تنبيه: تحديثات البنية التحتية مساء اليوم",
  "message": "<p>سيتم تنفيذ تحديثات…</p>",
  "priority": "HIGH",
  "status": "SCHEDULED",
  "channels": ["dashboardBanner", "inbox"],
  "audienceRoles": ["editor", "reporter", "admin"],
  "audienceUserIds": [],
  "tags": ["infra", "maintenance"],
  "attachments": [{"url": "/files/plan.pdf", "name": "Plan", "type": "application/pdf"}],
  "dismissible": true,
  "maxViewsPerUser": 3,
  "startAt": "2025-10-27T16:00:00+03:00",
  "endAt": "2025-10-27T23:00:00+03:00"
}


⸻

ملاحظات ختامية
	•	راعِ RTL بالكامل وتناسق التصميم حسب نظام “سبق الذكية”.
	•	اجعل المكوّنات قابلة لإعادة الاستخدام (Cards/Filters/Table/Editor/Timeline).
	•	وثّق الـAPI بـOpenAPI وغطِّ حالات الخطأ الشائعة.

المخرج المتوقع: Pull Request يضيف الجداول، الـAPIs، الواجهات، عنصر القائمة “التواصل الداخلي”، ووثائق مختصرة للاستخدام.

— انتهى البرمبت.