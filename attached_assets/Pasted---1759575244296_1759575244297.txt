

صمم نموذجًا متكاملًا لا يقتصر على تسجيل المستخدمين، بل يبني لكل منهم **"ملفًا شخصيًا حيًا"** يتطور معه، مما يخلق تجربة إعلامية فريدة وعميقة.

هذا التصميم يربط بين بيانات التسجيل، السلوك الفعلي، والتحليل النفسي للمستخدم لتحقيق أقصى درجات التخصيص.

---

### **النموذج المقترح: نظام العضوية الذكية "نبض"**

الفلسفة الأساسية هي أن كل تفاعل للمستخدم هو إشارة قيمة تساعدنا في فهمه بشكل أفضل، وكل فهم أفضل يؤدي إلى تجربة أكثر إرضاءً.

---

### **1. المخرجات النهائية: ملف المستخدم (User Profile) وآلية التوصية**

#### **أ) ملف المستخدم (JSON Profile)**

هذا هو الهيكل النهائي لبيانات المستخدم بعد دمج كل المصادر.

```json
{
  "id": "usr_12345",
  "name": "أحمد علي",
  "email": "ahmed.a@example.com",
  "createdAt": "2025-10-26T10:00:00Z",
  "isVerified": true,

  "interests": [
    { "id": "tech", "name": "التقنية", "weight": 0.9 },
    { "id": "economy", "name": "الاقتصاد", "weight": 0.7 },
    { "id": "sports", "name": "الرياضة", "weight": 0.5 }
  ],

  "behavior_log": {
    "last_7_days": {
      "clicks": {
        "tech": 45,
        "economy": 28,
        "sports": 15
      },
      "avg_read_time_seconds": {
        "tech": 180,
        "economy": 150,
        "sports": 90
      },
      "searches": ["الذكاء الاصطناعي", "سوق الأسهم السعودية"],
      "interactions": { "shares": 5, "comments": 3, "likes": 22 }
    }
  },

  "sentiment_profile": {
    "overall_score": 0.15, // (سلبي -1 إلى إيجابي +1)
    "emotional_breakdown": {
      "enthusiasm": 0.4,  // (حماس)
      "satisfaction": 0.3, // (رضا)
      "anger": 0.1,       // (غضب)
      "sadness": 0.05     // (حزن)
    },
    "trending_sentiments": ["enthusiasm", "satisfaction"] // المشاعر الصاعدة مؤخرًا
  },

  "personalized_feed": {
    "primary_topics": ["التقنية", "الاقتصاد"],
    "content_tone": ["تحليلي", "متفائل"],
    "recommended_articles": [
      { "id": "art_abc", "score": 0.95, "reason": "عالي الاهتمام + تفاعل سابق" },
      { "id": "art_def", "score": 0.88, "reason": "يتوافق مع مشاعر الرضا" }
    ]
  }
}
```

#### **ب) آلية التوصية (Recommendation Logic)**

هذه هي الدالة التي تولد `personalized_feed`. إنها مزيج مرجح من ثلاثة عوامل رئيسية.

```javascript
// pseudo-code for PersonalizationEngine

function generatePersonalizedFeed(userProfile, allArticles) {
  const recommendations = allArticles.map(article => {
    let score = 0;
    let reasons = [];

    // 1. درجة الاهتمامات (Interest Score) - وزن 40%
    const interestMatch = userProfile.interests.find(i => i.id === article.categoryId);
    if (interestMatch) {
      score += interestMatch.weight * 0.4;
      reasons.push("مطابق للاهتمامات المختارة");
    }

    // 2. درجة السلوك (Behavior Score) - وزن 40%
    const userBehavior = userProfile.behavior_log.last_7_days;
    const clicksInCategory = userBehavior.clicks[article.categoryId] || 0;
    const avgReadTime = userBehavior.avg_read_time_seconds[article.categoryId] || 0;
    
    // normalize and add to score
    score += (clicksInCategory / 50) * 0.2 + (avgReadTime / 200) * 0.2;
    if (clicksInCategory > 10) reasons.push("تفاعل عالي مع هذا القسم");

    // 3. درجة المشاعر (Sentiment Score) - وزن 20%
    if (article.sentiment) {
      const sentimentAlignment = calculateSentimentAlignment(userProfile.sentiment_profile, article.sentiment);
      score += sentimentAlignment * 0.2;
      if (sentimentAlignment > 0.5) reasons.push("يتوافق مع مزاجك العام");
    }

    return { ...article, score, reason: reasons.join(" + ") };
  });

  // ترتيب المقالات حسب الدرجة وإرجاع أفضل 10
  return recommendations.sort((a, b) => b.score - a.score).slice(0, 10);
}
```

---

### **2. تصميم قاعدة البيانات (Prisma Schema)**

هذا هو الأساس الذي يجمع كل هذه البيانات.

```prisma
// prisma/schema.prisma

model User {
  id                String    @id @default(cuid())
  name              String
  email             String    @unique
  passwordHash      String
  phone             String?   @unique
  age               Int?
  gender            Gender?
  isVerified        Boolean   @default(false)
  verificationCode  String?   @default("000000")
  fcmToken          String?

  // Relations
  interests         UserInterest[]
  behaviorLogs      BehaviorLog[]
  sentimentScores   SentimentScore[]
  createdAt         DateTime  @default(now())
}

model Interest {
  id          String @id @default(cuid())
  name        String @unique
  nameAr      String @unique // "التقنية"
  icon        String? // URL for an icon
  users       UserInterest[]
}

model UserInterest { // Many-to-Many relation
  id         String @id @default(cuid())
  userId     String
  interestId String
  weight     Float  @default(1.0) // How much the user likes this topic (can be updated by AI)
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  @@unique([userId, interestId])
}

model BehaviorLog {
  id        String   @id @default(cuid())
  userId    String
  eventType String   // 'click', 'read_time', 'search', 'share', 'comment'
  metadata  Json     // { articleId: '...', duration: 120, query: '...' }
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SentimentScore {
  id                String   @id @default(cuid())
  userId            String
  overallScore      Float    // -1 to 1
  emotionalBreakdown Json    // { enthusiasm: 0.4, ... }
  articleId         String?  // Optional: sentiment towards a specific article
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Gender { MALE, FEMALE, OTHER }
```

---

### **3. تجربة التسجيل واختيار الاهتمامات (UI/UX Flow)**

1.  **صفحة التسجيل:**
    *   نموذج أنيق وواضح يحتوي على الحقول الأساسية.
    *   التحقق من صحة البريد الإلكتروني وكلمة المرور في الواجهة الأمامية.
    *   عند الإرسال، يتم إنشاء المستخدم في قاعدة البيانات بحالة `isVerified: false` وإرسال بريد إلكتروني يحتوي على كود التفعيل (افتراضيًا `000000` للاختبار).

2.  **صفحة التفعيل:**
    *   بعد إدخال الكود الصحيح، يتم تحديث حالة المستخدم إلى `isVerified: true`.
    *   **يتم توجيه المستخدم فورًا وبدون أي تأخير إلى صفحة اختيار الاهتمامات.**

3.  **صفحة اختيار الاهتمامات:**
    *   تصميم يعتمد على **بطاقات قابلة للنقر (Clickable Cards)**، كل بطاقة تحتوي على أيقونة واسم القسم.
    *   **رسالة واضحة للمستخدم:** "اختر 3 على الأقل و5 كحد أقصى لنبني لك تجربة مخصصة".
    *   يتم تفعيل زر "متابعة" فقط عند تحديد العدد المطلوب.
    *   عند الضغط على "متابعة"، يتم حفظ الاختيارات في جدول `UserInterest` وتوجيه المستخدم للصفحة الرئيسية.

---

### **4. آلية تتبع السلوك وتحليل المشاعر**

#### **أ) تتبع السلوك (Behavior Tracking)**

*   **العميل (Client-Side):** يتم إضافة مكتبة تتبع مخصصة (أو استخدام `analytics.js`) ترسل الأحداث إلى نقطة نهاية API (`/api/events`).
*   **الخادم (Server-Side):** نقطة النهاية تستقبل الأحداث وتنشرها في Kafka topic اسمه `user.behavior`.
*   **معالج الأحداث (Event Processor):** خدمة مصغرة تستهلك هذه الأحداث من Kafka وتحفظها في جدول `BehaviorLog`.

#### **ب) تحليل المشاعر (Sentiment Analysis)**

*   **المحفز (Trigger):** عندما يضيف المستخدم تعليقًا، يتم إرسال حدث `user.comment.added` إلى Kafka.
*   **الخدمة المصغرة (`sentiment-analysis-service`):**
    1.  تستهلك الحدث.
    2.  تستخدم نموذج NLP متخصص في اللغة العربية (مثل AraBERT أو خدمة API من AWS Comprehend) لتحليل نص التعليق.
    3.  تستخرج الدرجة الإجمالية والانفعالات العاطفية (`enthusiasm`, `anger`, etc.).
    4.  تحفظ النتيجة في جدول `SentimentScore` المرتبط بالمستخدم.
    5.  تقوم بتحديث `sentiment_profile` للمستخدم بشكل دوري (مثلاً، كل 24 ساعة) لحساب المتوسطات والمشاعر الصاعدة.

---

### **5. تخصيص المحتوى (Personalization in Action)**

*   **الصفحة الرئيسية:** عند تحميل الصفحة، يتم استدعاء `PersonalizationEngine` لجلب قائمة المقالات المخصصة وعرضها في القسم الأعلى تحت عنوان "لك خصيصًا".
*   **النشرات البريدية:** مهمة مجدولة (Cron Job) تعمل يوميًا، تستدعي `PersonalizationEngine` لكل مستخدم مشترك في النشرة البريدية وترسل له قائمة بالمقالات الأعلى درجة.
*   **الإشعارات الذكية:** خدمة الإشعارات تستخدم `sentiment_profile` لإرسال تنبيهات. مثلاً: إذا كان المستخدم يميل إلى `enthusiasm` في التقنية، يتم إرسال إشعار عند نشر خبر تقني إيجابي ومثير.

---

### **6. لوحة التحكم (Admin Dashboard)**

*   **صفحة نظرة عامة على الأعضاء:**
    *   رسم بياني يوضح عدد التسجيلات اليومية/الأسبوعية.
    *   جدول بأحدث الأعضاء وحالة التحقق.
*   **ملف العضو الفردي:**
    *   عرض كامل للملف الشخصي JSON للمستخدم.
    *   رسوم بيانية تفاعلية لسلوكه (النقرات، وقت القراءة).
    *   "سحابة مشاعر" (Sentiment Cloud) تعبر عن حالته المزاجية.
*   **صفحة تحليلات الاهتمامات:**
    *   رسم بياني دائري (Pie Chart) يوضح أكثر 5 اهتمامات شيوعًا في المنصة.
    *   جدول يوضح متوسط وقت القراءة لكل قسم.
*   **صفحة تحليلات المشاعر:**
    *   "مقياس مزاج المنصة" (Platform Mood Meter) يوضح المزاج العام للمستخدمين.
    *   رسم بياني خطي يوضح تغير المزاج العام بمرور الوقت (مثلاً، خلال حدث معين).

بهذا النموذج، أنت لا تبني مجرد نظام عضويات، بل تبني **محرك شخصية ذكي** يفهم مستخدميه ويقدم لهم قيمة حقيقية، مما يضمن ولاءهم وتفاعلهم على المدى الطويل.