# ุฅุนุฏุงุฏ SendGrid ูุฏุนู ุงููุฑููุงุช ูู ูุธุงู ุงูุจุฑูุฏ ุงูุฐูู

## โ ุงููุดููุฉ ุงูุญุงููุฉ (ููููุจุฑ 17ุ 2025)
**ุงูุฅููููุงุช ูุง ุชุตู ุฅูู ุงููุธุงู ุฃุตูุงู!**

### ุงูุฃุนุฑุงุถ
1. ุนูุฏ ุฅุฑุณุงู ุฅููููุ ูุง ูุธูุฑ ูู ููุฌุงุช ุงูุณูุฑูุฑ
2. ูุง ููุญูุธ ุฃู ุณุฌู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (`email_webhook_logs`)
3. ุขุฎุฑ ุณุฌู ูู ุงููุงุนุฏุฉ: **2025-11-16** (ุฃูุณ)

### ุงูุณุจุจ ุงูุฌุฐุฑู
**SendGrid Inbound Parse Webhook ุบูุฑ ูููุนูู ุฃู ููุนุทูู!**

---

## ุงููุดููุฉ ุงูุณุงุจูุฉ (ุชู ุญููุง ูู ุงูููุฏ)
ุนูุฏ ุฅุฑุณุงู ุฅูููู ูุน ุตูุฑ ูุฑููุฉุ ูุชู ุชุฌุงูู ุงูุตูุฑ ููุนุงูุฌุฉ ุงููุต ููุท.

### ุงูุณุจุจ
1. โ **ุชู ุงูุญู**: ุงูููุฏ ูุงู ูุชุทูุจ `attachments.length === 0` ูุจู ุชุญููู ุงููุฑููุงุช
2. โ **ุชู ุงูุญู**: `simpleParser` ูุงู ูุณุชูุจู string ุจุฏูุงู ูู Buffer
3. โ **ูุง ูุฒุงู**: SendGrid Inbound Parse ูุง ููุฑุณู webhooks!

## ุงูุญู: ุชูุนูู ุฅุฑุณุงู ุงููุฑููุงุช ูู SendGrid

### ุงูุฎุทูุงุช ุงููุทููุจุฉ:

#### 1. ุงูุฏุฎูู ุฅูู SendGrid Dashboard
1. ุงูุชูู ุฅูู: https://app.sendgrid.com/
2. ุงุฐูุจ ุฅูู **Settings** โ **Inbound Parse**

#### 2. ุชุนุฏูู ุฅุนุฏุงุฏุงุช Inbound Parse
1. ุงุถุบุท ุนูู ุฅุนุฏุงุฏุงุช webhook ุงูููุฌูุฏ (ุฃู ุฃูุดุฆ ูุงุญุฏ ุฌุฏูุฏ)
2. ุชุฃูุฏ ูู ุชูุนูู **"Post the raw, full MIME message"**
   - โ ูุฐุง ุงูุฎูุงุฑ ููุฑุณู ุงูุฅูููู ุงููุงูู ุจูุง ููู ุงููุฑููุงุช
   
   **ุฃู**
   
3. ุฅุฐุง ููุช ุชุณุชุฎุฏู Parsed Mode:
   - ุชุฃูุฏ ูู ุฃู SendGrid ููุนุฏู ูุฅุฑุณุงู ุงููุฑููุงุช ููููุงุช ูููุตูุฉ
   - ุงูู webhook URL ูุฌุจ ุฃู ููุจู `multipart/form-data`

#### 3. ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช Webhook
ุชุฃูุฏ ูู ุฃู webhook URL ูู:
```
https://[YOUR-DOMAIN]/api/email-agent/webhook
```

#### 4. ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏ
ุจุนุฏ ุชูุนูู ุงูุฅุนุฏุงุฏุงุช:
1. ุฃุฑุณู ุฅูููู ุชุฌุฑูุจู ูุน ุตูุฑุฉ ูุฑููุฉ
2. ุชุญูู ูู ุงูุณุฌูุงุช (logs) - ูุฌุจ ุฃู ุชุฑู:
   ```
   [Email Agent] ๐ ============ ATTACHMENTS DETAILS ============
   [Email Agent] ๐ Attachment 1: {...}
   ```

## ููู ูุนูู ุงููุธุงู ุญุงูููุง

### ูุนุงูุฌุฉ ุงููุฑููุงุช ุงูููุฌูุฏุฉ
ุงูููุฏ **ุฌุงูุฒ ุจุงููุงูู** ููุนุงูุฌุฉ ุงููุฑููุงุช:

1. **ูููุงุช Word (.docx)**:
   - ุงุณุชุฎุฑุงุฌ ุงููุต ุชููุงุฆููุง
   - ุฏูุฌู ูุน ูุญุชูู ุงูุฅูููู
   - ุฑูุน ุงูููู ุงูุฃุตูู ุฅูู Google Cloud Storage

2. **ุงูุตูุฑ (jpg, png, gif, webp)**:
   - ุฑูุน ุชููุงุฆู ุฅูู Google Cloud Storage
   - ุงุฎุชูุงุฑ ุฃูู ุตูุฑุฉ ูุตูุฑุฉ ุจุงุฑุฒุฉ ููููุงู
   - ุญุฏ ุฃูุตู: 10MB ููู ุตูุฑุฉ

3. **ุงููุฑููุงุช ุงูุฃุฎุฑู**:
   - ุฑูุน ุชููุงุฆู ุฅูู Google Cloud Storage
   - ุญูุธ ุฌููุน ุงููุฑููุงุช ุญุชู ูู ุชู ุฑูุถ ุงูุฅูููู

### ุณุฌู ุงููุนุงูุฌุฉ (Logs)
ุนูุฏ ูุตูู ูุฑููุงุช ุจุดูู ุตุญูุญุ ุณุชุฑู ูู logs:

```
[Email Agent] ๐ ============ ATTACHMENTS DETAILS ============
[Email Agent] ๐ Attachment 1: {
  originalname: 'image.jpg',
  size: '245.67 KB',
  mimetype: 'image/jpeg',
  buffer: 'Present'
}
[Email Agent] ๐ ==========================================

[Email Agent] ๐ผ๏ธ ============ PROCESSING ATTACHMENTS ============
[Email Agent] ๐ธ Uploading image: image.jpg (245.67 KB)
[Email Agent] โ Image uploaded successfully: email-attachments/2025/11/image-abc123.jpg
[Email Agent] ๐จ Featured image selected: email-attachments/2025/11/image-abc123.jpg
```

## ุงูุญุงูุฉ ุงูุญุงููุฉ

### ูุง ูุนูู โ
- ุงุณุชูุจุงู ุงูุฅููููุงุช
- ุชุญููู ุงููุต ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
- ุงููุดุฑ ุงูุชููุงุฆู ููููุงูุงุช
- ูุนุงูุฌุฉ ูููุงุช Word

### ูุง ูุง ูุนูู โ
- **ุงููุฑููุงุช (ุงูุตูุฑ) ูุง ุชุตู ุฅูู ุงูุชุทุจูู**
- ุงูุณุจุจ: ุฅุนุฏุงุฏุงุช SendGrid ูุง ุชูุฑุณู ุงููุฑููุงุช

## ุงูุชุญูู ูู ุงููุดููุฉ

### ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช
ุฌููุน ุงูุฑุณุงุฆู ุงูุณุงุจูุฉ ุชุธูุฑ `attachments_count: 0`:

```sql
SELECT 
  from_email,
  subject,
  attachments_count,
  received_at
FROM email_webhook_logs
ORDER BY received_at DESC
LIMIT 5;
```

ุงููุชูุฌุฉ:
```
from_email          | subject                              | attachments_count
--------------------|--------------------------------------|------------------
aalhazmi@sabq.org   | ุฏุฑุงุณุฉ ุทุจูุฉ: ุทูุฑุงุช ุฌูููุฉ...          | 0
aalhazmi@sabq.org   | ุฎุจุฑ ุทุจู ููู                         | 0
```

**ุฌููุนูุง 0** - ูุนูู ุงููุฑููุงุช ูุง ุชุตู!

## ุงูุฅุฌุฑุงุก ุงููุทููุจ

1. โ **ููุฑู**: ุชุนุฏูู ุฅุนุฏุงุฏุงุช SendGrid ูุฅุฑุณุงู ุงููุฑููุงุช
2. โ **ุงุฎุชุจุงุฑ**: ุฅุฑุณุงู ุฅูููู ุชุฌุฑูุจู ูุน ุตูุฑุฉ
3. โ **ุชุญูู**: ูุญุต logs ููุชุฃูุฏ ูู ูุตูู ุงููุฑููุงุช

## ูุฑุงุฌุน ุชูููุฉ

- [SendGrid Inbound Parse Documentation](https://www.twilio.com/docs/sendgrid/for-developers/parsing-email/setting-up-the-inbound-parse-webhook)
- [Multer Documentation](https://github.com/expressjs/multer) (ููุชุจุฉ ูุนุงูุฌุฉ ุงููุฑููุงุช)

## ููุงุญุธุงุช ุฅุถุงููุฉ

### ุญุฏูุฏ ุงููุฑููุงุช
- **ุงูุญุฏ ุงูุฃูุตู ูุญุฌู ุงูููู**: 25MB (SendGrid limit)
- **ุงูุญุฏ ุงูุฃูุตู ููุตูุฑ**: 10MB ููู ุตูุฑุฉ
- **ุฃููุงุน ุงูุตูุฑ ุงููุฏุนููุฉ**: JPEG, PNG, GIF, WebP
- **ูููุงุช Word**: .docx ููุท

### ุงูุฃูุงู
- ุฌููุน ุงููุฑููุงุช ุชูุญูุธ ูู Google Cloud Storage
- ุงููุฑููุงุช ุชูุญูุธ ุญุชู ูู ุชู ุฑูุถ ุงูุฅูููู (ูููุฑุงุฌุนุฉ)
- ุงูุชุญูู ูู ููุน ุงูููู (MIME type validation)
- ุงูุชุญูู ูู ุญุฌู ุงูููู ูุจู ุงูุฑูุน
